name: Synthetic traffic (server + browser)

on:
  schedule:
    - cron: '15 7 * * *'      # daily at 07:15 UTC
    - cron: '*/30 * * * *'    # every 30 minutes
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (server + browser)
        run: |
          npm i posthog-node playwright @supabase/supabase-js
          npx playwright install --with-deps chromium

      - name: Restore persona state
        uses: actions/cache@v4
        with:
          path: .synthetic_state
          key: personas-shared-v1

      # --- SERVER EVENTS ---
      - name: Run synthetic server events
        run: node scripts/synthetic-traffic.js
        env:
          PH_PROJECT_API_KEY: ${{ secrets.PH_PROJECT_API_KEY }}
          PH_HOST: ${{ secrets.PH_HOST }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_URL: https://kawxtrzyllgzmmwfddil.supabase.co
          STATE_DIR: .synthetic_state
          PERSONA_POOL: 400

      # --- BROWSER FLOWS ---
      # New user signup journeys (creates real users)
      - name: Run new user signup journeys
        run: node scripts/playwright-journey-new-user.js
        env:
          STATE_DIR: .synthetic_state
          APP_URL: https://hogflix-demo.lovable.app
          NEW_USER_COUNT: 10
      
      # Returning user engagement sessions
      - name: Run returning user sessions
        run: node scripts/playwright-journey-returning-user.js
        env:
          STATE_DIR: .synthetic_state
          APP_URL: https://hogflix-demo.lovable.app
          RETURNING_USER_COUNT: 30
      
      # Legacy lightweight bot (optional, for quick funnel events)
      - name: Run legacy bot (quick funnel events)
        run: node scripts/playwright-bot.js
        env:
          STATE_DIR: .synthetic_state
          APP_URL: https://hogflix-demo.lovable.app

      - name: Save persona state
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .synthetic_state
          key: personas-shared-v1
