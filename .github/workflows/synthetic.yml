name: Synthetic traffic (personas + optional server pings)

on:
  schedule:
    - cron: '*/30 * * * *' # every 30 minutes
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # to push synthetic-state branch updates
    env:
      # Site URL (can override)
      HOGFLIX_URL: https://hogflix-demo.lovable.app/
      # PostHog env (for server-side script ONLY)
      POSTHOG_HOST: https://eu.i.posthog.com
      POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }} # <-- set in repo Settings > Secrets

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          npm i -D playwright ts-node typescript
          npx playwright install --with-deps chromium

      # Restore persona state from dedicated branch
      - name: Restore persona state
        run: |
          git fetch origin synthetic-state || true
          if git ls-remote --exit-code --heads origin synthetic-state; then
            git worktree add state synthetic-state
            mkdir -p .personas
            cp -r state/.personas .personas || true
          else
            echo "No synthetic-state branch yet; will create after first run."
          fi

      - name: Run persona simulator
        run: |
          node -e "require('ts-node/register'); require('./scripts/synthetic/run.ts')"

      # (Optional) Run server-side pings to smooth trends
      - name: Run server-side pings
        if: env.POSTHOG_API_KEY != ''
        run: node scripts/synthetic-traffic.js

      # Save updated persona state back to branch
      - name: Save persona state
        run: |
          mkdir -p state/.personas
          cp -r .personas state/.personas
          cd state
          git add .personas
          git -c user.name="hogflix-bot" -c user.email="github-actions@users.noreply.github.com" \
            commit -m "update personas $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "no changes"
          git push origin HEAD:synthetic-state || git push -u origin HEAD:synthetic-state
